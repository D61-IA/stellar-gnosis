{% extends "gnosis_theme.html" %}

{% block content %}
    {% load el_pagination_tags %}
    {% load humanize %}

    <div class="card shadow-sm mt-5">
        <div class="card-header">

            <div style="display: flex">
                <div style="display: flex; width: 11%;">
                    {% if user.is_authenticated %}
                        <div id="endorsement">
                            {% if not endorsed %}
                                <form id="e_create" action="{% url 'endorsement_create' id=paper.id %}"
                                      method="post">
                                    {% csrf_token %}
                                    <button name="endorse" value="endorse" style="border: none; outline: none !important;
                            background: none;" onclick="endorsement_bookmark_fun('#e_create', '#endorsement')">E</button>
                                </form>


                            {% else %}
                                <form id="e_undo" action="{% url 'endorsement_undo' id=paper.id %}" method="post">
                                    {% csrf_token %}
                                    <button name="undo_endorse" value="endorse" style="border: none; outline: none !important;
                            background: none;" onclick="endorsement_bookmark_fun('#e_undo', '#endorsement')">E
                                    </button>
                                </form>
                            {% endif %}
                        </div>

                        <div id="bookmark">
                                <form id="b_create" action="{% url 'paper_bookmark' id=paper.id %}" method="post">
                                    {% csrf_token %}
                                    <button name="bookmark" value="B" style="border: none; outline: none !important;
                            background: none;" onclick="endorsement_bookmark_fun('#b_create', '#bookmark')">B</button>
                                </form>
                        </div>
                    {% else %}
                        <form action="{% url 'login' %}?next={{ request.path }}" method="post">
                            {% csrf_token %}
                            <button name="endorse" value="endorse" style="border: none; outline: none !important;
                            background: none;">E
                            </button>
                        </form>
                        <form action="{% url 'login' %}?next={{ request.path }}" method="post">
                            {% csrf_token %}
                            <button name="bookmark" value="bookmark" style="border: none; outline: none !important;
                            background: none;">B
                            </button>
                        </form>
                    {% endif %}
                </div>
                <h3>{{ paper.title }}</h3>
            </div>

            <h4>
                <div style="display: flex; align-content: space-between; justify-content: space-between">
                    <div><a href={{ paper.download_link }} class="btn btn-primary" role="button"
                        target="_blank">Download</a>
                        {% if user.is_authenticated %}
                            <a href="{% url 'paper_add_to_group' paper.id %}" class="btn btn-primary"
                               role="button">
                                Add to Group</a>
                            <a href="{% url 'paper_add_to_collection' paper.id %}" class="btn btn-primary"
                               role="button">
                                Add to Collection</a>
                            <a href="{% url 'paper_update' paper.id %}" class="btn btn-danger btn-sm"
                               role="button">
                                Edit</a>
                        {% endif %}
                    </div>


                </div>
            </h4>
        </div>
        <div class="card-body">
            <h5 class="text-left">
                {{ authors }} {% if user.is_authenticated and user.is_superuser and authors %}<a

                    href="{% url 'paper_authors' id=paper.id %}"
                    class="btn btn-danger btn-sm" role="button">
                Edit</a>{% endif %}
            </h5>

            <h5 class="text-right">
                <small>keywords: {{ paper.keywords }}</small>
            </h5>

            <p><strong>Abstract:</strong> {{ paper.abstract }} </p>
            {% if venue %}
                <p>
                    <small><strong>Venue:</strong> {{ venue }}</small>
                </p>
            {% endif %}

            {% if messages %}
                {% for message in messages %}
                    <p class="bg-success">{{ message }}</p>
                {% endfor %}
            {% endif %}

            <h4 class="text-right">
                {% if not user.is_authenticated %}
                    <a href={% url 'login' %}>Endorse</a>{% endif %}
                {% if user.is_authenticated %}

                    <div>
                        <div>Connect with:
                            <a href="{% url 'paper_connect_paper' paper.id %}">Paper</a>
                            || <a href="{% url 'paper_connect_venue' paper.id %}">Venue</a> ||
                            <a href="{% url 'paper_connect_author' paper.id %}">Author</a> ||
                            <a href="{% url 'paper_connect_dataset' paper.id %}">Dataset</a> ||
                            <a href="{% url 'paper_connect_code' paper.id %}">Code Repo</a>
                        </div>


                    </div>
                {% endif %}</h4>
        </div>
    </div>
    {% if user.is_authenticated and user.is_superuser %}
        <div class="card text-left shadow-sm mb-3 mt-3">
            <div class="card-header"><strong>Admin functions</strong></div>
            <div class="card-body">
                <a href="{% url 'paper_delete' paper.id %}" class="btn btn-danger btn-sm" role="button">Delete Paper</a>
            </div>
        </div>
    {% endif %}
    {% if codes %}
        <div class="card shadow-sm mt-3">
            <div class="card-header"><h4>Code</h4></div>
            <div class="card-body">
                <ul class="list-group">
                    {% for code in codes %}
                        <li class="list-group-item"><h6><a href="{{ code.get_absolute_url }}">{{ code.website }}</a>
                        </h6></li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    {% endif %}

    <div class="card mt-3 shadow-sm">
        <div id="ego-header" class="card-header">
            <h4>Ego-graph</h4>

            <i class="material-icons drop_indicator">
                arrow_drop_up
            </i>

        </div>

        <div id="ego-graph-content">

            <div class="ego-button-container">
                <div class="flex_layout_row legend_container">
                    <div class="flex_layout_col legend_ele" onclick="show_cites('all', 'Paper')"><span
                            class="color_legend paper"></span> Paper
                    </div>
                    <div class="flex_layout_col legend_ele" onclick="show_cites('all', 'Person')"><span
                            class="color_legend person"></span> Person
                    </div>
                    <div class="flex_layout_col legend_ele" onclick="show_cites('all', 'Venue')"><span
                            class="color_legend venue"></span> Venue
                    </div>
                    <div class="flex_layout_col legend_ele" onclick="show_cites('all', 'Code')"><span
                            class="color_legend code"></span> Code
                    </div>
                    <div class="flex_layout_col legend_ele" onclick="show_cites('all', 'Dataset')"><span
                            class="color_legend dataset"></span>
                        Dataset
                    </div>
                </div>

                <div class="flex_layout_row widget_container">
                    <div id="hide-refresh" class="flex_layout_row" style="padding: 5px">
                        <button type="button"
                                class="btn btn-primary ego-button" title="Reset"
                                onclick="reset_nodes()">
                            <i class="material-icons">
                                refresh
                            </i>
                        </button>
                        <button type="button"
                                class="btn btn-primary ego-button" title="Hide relationships"
                                data-toggle="button"
                                aria-pressed="false" onclick="toggle_relas()">
                            <i class="material-icons" id="rela_toggle">
                                visibility
                            </i>
                        </button>

                    </div>

                    <div class="flex_layout_row" style="padding-right: 5px">
                        <select id="graphfilter"
                                onchange="show_cites(this.value, 'all')"
                                style="height: 35px; margin-top: auto; margin-bottom: auto">
                            <option value="all"> all</option>
                            <option value="cites"> cites</option>
                            <option value="uses"> uses</option>
                            <option value="extends"> extends</option>
                            <option value="authors"> authors</option>
                            <option value="was published at"> was published at</option>
                            <option value="evaluates on"> evaluates on</option>
                            <option value="published"> published</option>
                            <option value="implements"> implements</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="card-body" style="padding-top: 0">

                <div id="cy">
                    <div id="tooltip" hidden>
                        <span></span>
                    </div>
                </div>
            </div>

        </div>
    </div>


    <div class="card shadow-sm mt-5">
        {#    Comments / Notes heading #}
        <div class="card-header">
            {% if user.is_authenticated %}
                <h3>Comments / Notes</h3>
            {% else %}
                <h3>Comments</h3>
            {% endif %}
        </div>

        <div class="card-body">
            {#        Navigation bar in tag view, show the comment and note tab depending on the login condition #}
            {% if user.is_authenticated %}
                <nav>
                    <div class="nav nav-tabs" id="nav-tab" role="tablist">
                        <a class="nav-item nav-link active" id="nav-comment-tab" data-toggle="tab" href="#navcomment"
                           role="tab" aria-controls="navcomment" aria-selected="true">Comments</a>
                        <a class="nav-item nav-link " id="nav-note-tab" data-toggle="tab" href="#navnote" role="tab"
                           aria-controls="navnote" aria-selected="false">Notes</a>
                    </div>
                </nav>

                <div class="tab-content" id="nav-tabContent">
                    {#            tab content of comment tab#}
                    <div class="tab-pane fade show active" id="navcomment" role="tabpanel"
                         aria-labelledby="nav-comment-tab">
                        <div class="mt-2">
                            {#                            comment form#}
                            <form action="" method="POST" id="comment-form">
                                {% csrf_token %}
                                {{ commentform }}
                                <input type="submit" name="comment_form" class="btn btn-info mt-3 btn-md captcha-submit"
                                       value="Post a comment"/>
                                <small class="mt-2 float-right">* Comments are public and visible to all users.</small>
                            </form>
                        </div>
                        <br/>
                        {#                    show comments#}
                        {% if comments %}
                            <ul class="list-group list-group-flush">
                            {% paginate comments %}
                            {% for comment in comments %}

                                <li class="list-group-item shadow-sm mt-1">
                                   <p><strong>{{ comment.created_by }}</strong> said on
                                    {{ comment.created_at|date:"F d, Y" }}</p>
                                    {% if comment.is_flagged %}
                                        <p>Comment is being held for moderation</p>
                                    {% else %}
                                        <p>{{ comment.text }}</p>
                                    {% endif %}
                                    {% if comment.created_by == user %}
                                        <a href="{% url 'comment_update' comment.id %}">Edit</a>
                                    {% endif %}
                                </li>

                                {% if 0 %}
                                    <li id="cmt_thread_{{ comment.id }}" class="list-group-item shadow-sm mt-1">
                                        {% if comment.created_by != user %}
                                            <div style="float: right; text-align: right;">
                                                <i class="material-icons more_vert">
                                                    more_vert
                                                </i>
                                                <div class="popup" hidden>
                                                    <div class="more_menu box_shadow">
                                                        <div class="opt_container open_flag_dialog"
                                                             data-url="{% url 'comment_flag_create' comment.id %}"
                                                             data-commentid={{ comment.id }}>
                                                            <i class="material-icons menu_item">
                                                                outlined_flag
                                                            </i>
                                                            <span class="menu_item">Report</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endif %}
                                        <p><strong>{{ comment.created_by }}</strong>
                                            <small class="ml-3 text-muted">{{ comment.created_at }}</small>
                                            {% if comment.created_by == user %}
                                                <a class="ml-5" href="{% url 'comment_update' comment.id %}">Edit</a>
                                            {% endif %}
                                        </p>
                                        <p>{{ comment.text }}</p>
                                    </li>
                                {% endif %}
                            {% endfor %}
                            {% get_pages %}
                            <ul class="pagination justify-content-center" style="margin:20px 0">
                                {% if not pages.current.is_first %}
                                    <li class="page-item"><a class="page-link"
                                                             href="{{ pages.previous.path }}">Previous</a>
                                    </li>
                                {% endif %}
                                {% for page in pages %}
                                    {% if page.is_current %}
                                        <li class="page-item active"><a class="page-link"
                                                                        href="{{ page.path }}">{{ page.number }}</a>
                                        </li>
                                    {% else %}
                                        <li class="page-item"><a class="page-link"
                                                                 href="{{ page.path }}">{{ page.number }}</a></li>
                                    {% endif %}
                                {% endfor %}
                                {% if not pages.current.is_last %}
                                    <li class="page-item"><a class="page-link" href="{{ pages.next.path }}">Next</a>
                                    </li>
                                {% endif %}
                            </ul>
                        {% endif %}
                    </div>

                    {#              tab content of note tab#}
                    <div class="tab-pane fade" id="navnote" role="tabpanel" aria-labelledby="nav-note-tab">
                        <div class="mt-2">
                            {#                            note form#}
                            <form action="" method="post">
                                {% csrf_token %}
                                {{ noteform }}
                                <input type="submit" name="note_form" class="btn btn-info mt-3 btn-md"
                                       value="Post a note"/>
                                <small class="mt-2 float-right">* Notes are private and only visible to the
                                    creator</small>
                            </form>
                        </div>
                        <br/>
                        {% if num_notes > 0 %}
                            <ul class="list-group list-group-flush">
                                {% paginate notes %}
                                {% for note in notes %}
                                    <li class="list-group-item shadow-sm mt-1">
                                        <p>{{ note.note_content }}</p>
                                        <p>Date:
                                            <small class="ml-0 pr-5 text-muted">{{ note.created_at|naturaltime }}</small>
                                            Modified:
                                            <small class="ml-0 text-muted">{{ note.updated_at|naturaltime }}</small>
                                            <a class="ml-5" href="{% url 'note_update' note.id %}">Edit</a>
                                            <a class="ml-5" href="{% url 'note_delete' note.id %}"> Delete</a>
                                        </p>
                                    </li>
                                {% endfor %}

                                {% get_pages %}
                                <!-- Center-aligned -->
                                <ul class="pagination justify-content-center" style="margin:20px 0">
                                    {% if not pages.current.is_first %}
                                        <li class="page-item"><a class="page-link"
                                                                 href="{{ pages.previous.path }}">Previous</a></li>
                                    {% endif %}
                                    {% for page in pages %}
                                        {% if page.is_current %}
                                            <li class="page-item active"><a class="page-link"
                                                                            href="{{ page.path }}">{{ page.number }}</a>
                                            </li>
                                        {% else %}
                                            <li class="page-item"><a class="page-link"
                                                                     href="{{ page.path }}">{{ page.number }}</a></li>
                                        {% endif %}
                                    {% endfor %}
                                    {% if not pages.current.is_last %}
                                        <li class="page-item"><a class="page-link" href="{{ pages.next.path }}">Next</a>
                                        </li>
                                    {% endif %}
                                </ul>
                            </ul>
                        {% endif %}
                    </div>
                </div>
                {#        if the user is not login#}
                {#                <a href="{% url 'django_registration_register' %}">register a new#}
                {#                    account!</a>#}
            {% else %}
                <h4 class="mt-2 mb-2"><a href="{% url 'django_registration_register' %}?next={{ request.path }}">Sign
                    up</a> or <a href="{% url 'login' %}?next={{ request.path }}">login</a> to leave
                    a comment</h4>
                {% if comments %}
                    <ul class="list-group list-group-flush">
                        {% for comment in comments %}
                            <li class="list-group-item shadow-sm mt-1">
                                <div style="float: right; text-align: right;">
                                    <i class="material-icons more_vert">
                                        more_vert
                                    </i>
                                    <div class="popup" hidden>
                                        <div class="more_menu box_shadow">
                                            <a class="opt_container icon_link"
                                               href="{% url 'login' %}?next={{ request.path }}">
                                                <i class="material-icons menu_item">
                                                    outlined_flag
                                                </i>
                                                <span class="menu_item">Report</span>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                                <p><strong>{{ comment.created_by }}</strong>
                                    <small class="ml-3 text-muted">{{ comment.created_at|date:"F d, Y" }}</small>
                                </p>
                                <p>{{ comment.text }}</p>
                            </li>
                        {% endfor %}
                    </ul>
                {% endif %}
            {% endif %}
        </div>
    </div>

    <!-- start-flagging -->
    <div id="flag_form_container" class="cover popup" hidden>
        <div id="flag_form_dialog" class="box_shadow">
            <form id="flag_form" action="" method="post">
                {% csrf_token %}
                <table class="w-75">
                    {% for field in flag_form %}
                        <div style="font-weight: bold">
                            {{ field.label_tag }}
                        </div>
                        <div style="padding: 0 10px">
                            {{ field }}
                        </div>
                        {% if field.help_text %}
                            {{ field.help_text }}
                        {% endif %}
                        {% for error in field.errors %}
                            {{ error }}
                        {% endfor %}
                    {% endfor %}
                </table>
                <br/>
                <div class="form_button_container">
                    <button type="button" class="btn btn-primary btn-lg form_button"
                            onclick="cancel_form()">
                        Cancel
                    </button>
                    <input type="submit" class="btn btn-primary btn-lg form_button" value="Submit"/>
                </div>
            </form>
        </div>
    </div>


    <!-- if form is valid show the form in the popup window -->
    {% if flag_form.has_changed %}
        <script>$('.cover').attr('hidden', false);</script>
    {% endif %}

    <!-- end-flagging -->

    {% load static %}

    <script type="text/javascript">

        // concentric level value
        var paper_count = 50;

        // define layout options
        var layout = {
            name: 'concentric',
            concentric: (node) => {
                if (node.data('label') === "origin") return paper_count + 50;
                // all levels have the same value => one big circle only
                return paper_count;
            },
            padding: 20,
            startAngle: 2 * Math.PI,
            minNodeSpacing: 25,
            nodeDimensionsIncludeLabels: true,
        };

        var cy = cytoscape({
            container: document.getElementById('cy'), // container to render in
            elements: {{ ego_network | safe }},

            // mouse wheel sensitivity, used for zooming
            wheelSensitivity: 0.1,

            layout: layout,

            // max zoom factor
            maxZoom: 2.0,

            style: [ // styling the graph
                {
                    selector: 'node[type="Paper"]',
                    style: getCustomNodeStyle({
                        'background-color': '#39acff'
                    }),
                },
                {
                    selector: 'node[label="origin"]',
                    style: getCustomNodeStyle({
                        'width': 30,
                        'height': 30,
                        'background-color': '#39acff',
                    }),
                },
                {
                    selector: 'node[type="Person"]',
                    style: getCustomNodeStyle({
                        'background-color': '#ffb836',
                        'label': 'data(last_name)',
                    }),

                },
                {
                    selector: 'node[type="Venue"]',
                    style: getCustomNodeStyle({
                        'background-color': '#d97fff',
                    }),

                },
                {
                    selector: 'node[type="Dataset"]',
                    style: getCustomNodeStyle({
                        'background-color': '#ff723d',
                    }),

                },
                {
                    selector: 'node[type="Code"]',
                    style: getCustomNodeStyle({
                        'background-color': '#59d143',
                    }),

                },
                {
                    selector: 'node[type="Comment"]',
                    style: getCustomNodeStyle({
                        'background-color': '#9d8b71',
                    }),
                },
                {
                    selector: 'edge[label="cites"]',
                    style: getCustomEdgeStyle({
                        'line-color': '#2bd6ad',
                        'target-arrow-color': '#2bd6ad',
                    }),
                },
                {
                    selector: 'edge[label="uses"]',
                    style: getCustomEdgeStyle({
                        'line-color': '#4a8ee7',
                        'target-arrow-color': '#4a8ee7',
                    }),
                },
                {
                    selector: 'edge[label="extends"]',
                    style: getCustomEdgeStyle({
                        'line-color': '#31c5ff',
                        'target-arrow-color': '#31c5ff',
                    }),
                },
                {
                    selector: 'edge[label="authors"]',
                    style: getCustomEdgeStyle({
                        'line-color': '#ffb836',
                        'target-arrow-color': '#ffb836',
                    }),
                },
                {
                    selector: 'edge[label="evaluates on"]',
                    style: getCustomEdgeStyle({
                        'line-color': '#ff723d',
                        'target-arrow-color': '#ff723d',
                    }),
                },
                {
                    selector: 'edge[label="published"]',
                    style: getCustomEdgeStyle({
                        'line-color': '#ff607a',
                        'target-arrow-color': '#ff607a',
                    }),
                },
                {
                    selector: 'edge[label="was published at"]',
                    style: getCustomEdgeStyle({
                        'line-color': '#d97fff',
                        'target-arrow-color': '#d97fff',
                    }),
                },
                {
                    selector: 'edge[label="implements"]',
                    style: getCustomEdgeStyle({
                        'line-color': '#59d143',
                        'target-arrow-color': '#59d143',
                    })
                },
                {
                    selector: 'edge[label="discusses"]',
                    style: getCustomEdgeStyle({
                        'line-color': '#9d8b71',
                        'target-arrow-color': '#9d8b71',
                    }),
                }
            ],

        });

        // setting the minimum zoom factor to 50% of its initial zoom
        cy.minZoom(cy.zoom()* 0.5);
    </script>

    <script src="{% static "js/ego_graph.js" %}"></script>
    <script src="{% static "js/flagging.js" %}"></script>

    <script type="text/javascript"> window.CSRF_TOKEN = "{{ csrf_token }}"; </script>
    <script src="{% static "js/endorsement-bookmark.js" %}"></script>

{% endblock %}